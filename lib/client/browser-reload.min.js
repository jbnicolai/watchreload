(function(window,document,io,reloader){var isIE=!!document.createStyleSheet;var navigator=window.navigator;var CSSRule=window.CSSRule;var URL_STYLE_REGEXP=/url\s*\(\s*['"]?\s*([^\s'"]*)\s*['"]?\s*\)/g;reloader.util={trim:function(str){return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},isArray:function(value){return"[object Array]"==Object.prototype.toString.call(value)},escapeRegExp:function(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},getPathSegments:function(path){var segments=path.split("/");var validSegments=[];for(var i=0,len=segments.length;i<len;i++){var part=segments[i];if(part){validSegments.push(part)}}return validSegments},isAbsolutePath:function(path){return/^\w+:\/\//.test(path)},getAbsolutePath:function(base,relative){var utils=reloader.util;if(utils.isAbsolutePath(relative)){return relative}if(base){base=utils.parseURL(base).url}else{base=utils.parseURL(window.location.href).url}var relativePathInfo=utils.parseURL(relative);var fullPaths=utils.getPathSegments(base);var relativePaths=utils.getPathSegments(relativePathInfo.url);if(!/\/$/.test(base)){fullPaths.pop()}for(var i=0,len=relativePaths.length;i<len;i++){var part=relativePaths[i];if(part==="."){continue}if(part===".."){fullPaths.pop()}else{fullPaths.push(part)}}var firstPart=fullPaths[0];if(/^\w+:$/.test(firstPart)){fullPaths[0]=firstPart+"/"}return fullPaths.join("/")+relativePathInfo.param+relativePathInfo.hash},parseURL:function(url){var index;var hash="";if((index=url.indexOf("#"))>=0){hash=url.slice(index);url=url.slice(0,index)}var param="";if((index=url.indexOf("?"))>=0){param=url.slice(index);url=url.slice(0,index)}return{url:url,param:param,hash:hash}},addQueryTimestamp:function(url,timeStamp){var urlInfo=reloader.util.parseURL(url);var param=urlInfo.param;var versionParam="browserreload="+(timeStamp||(new Date).getTime());var newParam=param.replace(/(\?|&)browserreload=(\d+)/,"$1"+versionParam);if(newParam===param){newParam=param+((param?"&":"?")+versionParam)}return urlInfo.url+newParam+urlInfo.hash},getMatchRatio:function(rawPaths,toMatchPaths){var rawLen=rawPaths.length;var toMatchLen=toMatchPaths.length;var matchNum=0;for(var i=rawLen-1,j=toMatchLen-1;i>=0&&j>=0;i--,j--){if(rawPaths[i]===toMatchPaths[j]){matchNum++}else{break}}return parseInt(matchNum/rawLen*100)},findMaxMatchFile:function(path,fileInfoList){var utils=reloader.util;var changePaths=utils.getPathSegments(utils.parseURL(path).url);var maxMatch=null;var maxMatchFiles=[];for(var i=0,len=fileInfoList.length;i<len;i++){var file=fileInfoList[i];var fullHref=file.fullHref||utils.getAbsolutePath(null,file.href);var toMatchPaths=utils.getPathSegments(utils.parseURL(fullHref).url);var ratio=utils.getMatchRatio(changePaths,toMatchPaths);var isFullMatch=ratio===100;if(!maxMatch||isFullMatch||maxMatch.ratio<ratio){maxMatch={file:file,ratio:ratio,isFullMatch:isFullMatch};if(isFullMatch){maxMatchFiles.push(maxMatch)}}}if(!maxMatchFiles.length&&maxMatch){maxMatchFiles.push(maxMatch)}return maxMatchFiles}};function pollStyleLoadState(styleElem,callback){var isLoaded=false;var styleSheet=styleElem.sheet;if(/webkit/i.test(navigator.userAgent)){isLoaded=!!styleSheet||styleSheet===null}else if(styleSheet){try{isLoaded=!!styleSheet.cssRules}catch(ex){if(/security|insecure/i.test(ex.message)){isLoaded=true}}}if(isLoaded){setTimeout(function(){callback()},1)}else{setTimeout(function(){pollStyleLoadState(styleElem,callback)},1)}}reloader.dom={styleEvent:{},querySelectorAll:function(selector){if(document.querySelectorAll){return document.querySelectorAll(selector)}else if(typeof jQuery!=="undefined"){return jQuery(selector)}else{return null}},getLinkStyles:function(){var linkElems=document.getElementsByTagName("link");var linkStyles=[];for(var i=0,len=linkElems.length;i<len;i++){var link=linkElems[i];if(link.rel==="stylesheet"&&!link.browserReloading){linkStyles.push(link)}}return linkStyles},getStyleOwnerNode:function(styleSheet){var ownerNode;while(styleSheet){ownerNode=styleSheet.ownerNode||styleSheet.owningElement;if(ownerNode){return ownerNode}else{styleSheet=styleSheet.parentStyleSheet}}},extractImportStyleHref:function(href){href=reloader.util.trim(href);var extractURLResult=URL_STYLE_REGEXP.exec(href);if(extractURLResult&&extractURLResult.length===2){href=extractURLResult[1]}else if(!extractURLResult){extractURLResult=/^\s*['"]\s*([^\s]*)\s*['"]/.exec(href)}if(extractURLResult&&extractURLResult.length===2){href=extractURLResult[1]}return href},getImportStyleFullHref:function(importStyle){var rule=importStyle.rule;var href=importStyle.href;var parentStyle=rule.parentStyleSheet;var getAbsolutePath=reloader.util.getAbsolutePath;var basePath=parentStyle.href&&getAbsolutePath("",parentStyle.href);href=getAbsolutePath(basePath,href);return href},collectImportStyles:function(styleSheet,result){var ruleList;try{ruleList=styleSheet.cssRules}catch(e){return}var isModernBrowser=!!ruleList;if(!ruleList){ruleList=styleSheet.imports}var link=reloader.dom.getStyleOwnerNode(styleSheet);if(!ruleList||!ruleList.length){return}var extractImportStyleHref=reloader.dom.extractImportStyleHref;var getImportStyleFullHref=reloader.dom.getImportStyleFullHref;var collectImportStyles=reloader.dom.collectImportStyles;for(var i=0,len=ruleList.length;i<len;i++){var rule=ruleList[i];if(CSSRule&&rule.type===CSSRule.IMPORT_RULE||!CSSRule){var href=extractImportStyleHref(rule.href);var importStyle={link:link,rule:rule,index:i,href:href};importStyle.fullHref=getImportStyleFullHref(importStyle);result.push(importStyle);collectImportStyles(isModernBrowser?rule.styleSheet:rule,result)}}},getImportStyles:function(){var styleSheets=document.styleSheets;var importStyles=[];for(var i=0,len=styleSheets.length;i<len;i++){reloader.dom.collectImportStyles(styleSheets[i],importStyles)}return importStyles},setStyleSupportEvent:function(event,hasNativeSupport){reloader.dom.styleEvent[event]=hasNativeSupport},isStyleSupportEvent:function(event){return reloader.dom.styleEvent[event]},styleOnLoad:function(styleElem,callback){var onLoad=function(){if(onLoad.called){return}onLoad.called=true;callback&&callback()};styleElem.onload=function(){reloader.dom.setStyleSupportEvent("load",true);onLoad()};styleElem.onerror=function(){onLoad()};if(!reloader.dom.isStyleSupportEvent("load")){setTimeout(function(){pollStyleLoadState(styleElem,onLoad)},0)}},reloadLinkStyle:function(link){if(link.browserReloading){return}var cloneLink=link.cloneNode();cloneLink.href=reloader.util.addQueryTimestamp(cloneLink.href);link.browserReloading=true;var parentNode=link.parentNode;if(parentNode.lastChild===link){parentNode.appendChild(cloneLink)}else{parentNode.insertBefore(cloneLink,link.nextSibling)}reloader.dom.styleOnLoad(cloneLink,function(){var parentNode=link.parentNode;if(parentNode){parentNode.removeChild(link)}})},reloadImportStyle:function(importStyle){var rule=importStyle.rule;var index=importStyle.index;var href=reloader.util.addQueryTimestamp(importStyle.fullHref);var media="";try{media=rule.media||"";typeof media!=="string"&&(media=[].join.call(rule.media,", "))}catch(e){}var newRule='@import url("'+href+'") '+media+";";var parentStyle=rule.parentStyleSheet;if(parentStyle.insertRule){parentStyle.insertRule(newRule,index)}else if(parentStyle.addImport){parentStyle.addImport(href,index)}var removePosition=index+1;if(parentStyle.deleteRule&&parentStyle.cssRules.length>removePosition){parentStyle.deleteRule(removePosition)}else if(parentStyle.removeImport&&parentStyle.imports.length>removePosition){parentStyle.removeImport(removePosition)}}};if(isIE){reloader.dom.setStyleSupportEvent("load",true)}reloader.getReloadFile=function(changePath){var livereloadPathMap=reloader.options.livereload||{};for(var path in livereloadPathMap){if(livereloadPathMap.hasOwnProperty(path)){var regex=new RegExp(path);if(regex.test(changePath)){return livereloadPathMap[path]}}}return changePath};reloader.options={logLevel:"info",livereload:{}};var IMAGE_STYLES=[{selector:"background",styleNames:["backgroundImage"]},{selector:"border",styleNames:["borderImage","webkitBorderImage","MozBorderImage"]}];function updateCSSImageStyle(style,styleNames,updateImageInfo){var basePath=updateImageInfo.basePath;var path=updateImageInfo.path;var reloadVersion=updateImageInfo.reloadVersion;var hasUpdate=false;var escapeRegExp=reloader.util.escapeRegExp;for(var i=0,len=styleNames.length;i<len;i++){var name=styleNames[i];var value=style[name];if(!value){continue}var maxMatchImage=null;var result;var imgHref;while(result=URL_STYLE_REGEXP.exec(value)){imgHref=result.length===2?result[1]:null;if(!imgHref){continue}maxMatchImage=reloader.util.findMaxMatchFile(path,[{fullHref:reloader.util.getAbsolutePath(basePath,imgHref)}])[0];if(maxMatchImage.isFullMatch){break}}if(maxMatchImage&&maxMatchImage.isFullMatch){style[name]=value.replace(new RegExp(escapeRegExp(imgHref),"g"),reloader.util.addQueryTimestamp(imgHref,reloadVersion));hasUpdate=true}}return hasUpdate}function updateStyleSheetImage(styleSheet,updateImageInfo){var cssRules=[];try{cssRules=styleSheet.cssRules||styleSheet.rules}catch(e){return false}var hasReload=false;var result;for(var i=0,len=cssRules.length;i<len;i++){var rule=cssRules[i];if(!CSSRule||rule.type===CSSRule.STYLE_RULE){for(var j=0,jLen=IMAGE_STYLES.length;j<jLen;j++){var styleInfo=IMAGE_STYLES[j];result=updateCSSImageStyle(rule.style,styleInfo.styleNames,updateImageInfo);hasReload||(hasReload=result)}}else if(CSSRule&&rule.type===CSSRule.MEDIA_RULE){result=updateStyleSheetImage(rule,updateImageInfo);hasReload||(hasReload=result)}}return hasReload}function reloadStyleSheetImage(path,reloadVersion){var hasReload=false;var result;var styleSheets=document.styleSheets;var getAbsolutePath=reloader.util.getAbsolutePath;for(var i=0,len=styleSheets.length;i<len;i++){var sheet=styleSheets[i];var href=sheet.href;result=updateStyleSheetImage(sheet,{basePath:href&&getAbsolutePath(null,href),path:path,reloadVersion:reloadVersion});hasReload||(hasReload=result)}var importStyles=reloader.dom.getImportStyles();for(i=0,len=importStyles.length;i<len;i++){var importStyle=importStyles[i];var rule=importStyle.rule;result=updateStyleSheetImage(rule.styleSheet||rule,{basePath:importStyle.fullHref,path:path,reloadVersion:reloadVersion});hasReload||(hasReload=result)}return hasReload}function reloadInlineStyleImage(path,reloadVersion){var hasReload=false;var querySelectorAll=reloader.dom.querySelectorAll;for(var i=0,len=IMAGE_STYLES.length;i<len;i++){var styleInfo=IMAGE_STYLES[i];var foundElements=querySelectorAll("[style]")||[];for(var j=0,jLen=foundElements.length;j<jLen;j++){var result=updateCSSImageStyle(foundElements[j].style,styleInfo.styleNames,{path:path,reloadVersion:reloadVersion});hasReload||(hasReload=result)}}return hasReload}function reloadImageElement(path,reloadVersion){var imageElements=document.images;var imageFileList=[];for(var i=0,len=imageElements.length;i<len;i++){var img=imageElements[i];imageFileList[i]={href:img.src,img:img}}var hasReload=false;var maxMatchImages=reloader.util.findMaxMatchFile(path,imageFileList);for(i=0,len=maxMatchImages.length;i<len;i++){var matchImg=maxMatchImages[i];if(matchImg.isFullMatch){matchImg.file.img.src=reloader.util.addQueryTimestamp(matchImg.file.href,reloadVersion);hasReload=true}}return hasReload}reloader.command={init:function(data){var options=reloader.options;options.livereload=data.livereload||{};for(var k in data){if(data.hasOwnProperty(k)){options[k]=data[k]}}},reloadCSS:function(data){var changeFilePath=reloader.getReloadFile(data.path);var hasMatch=false;var linkStyles=reloader.dom.getLinkStyles();var importStyles=reloader.dom.getImportStyles();var findMaxMatchFile=reloader.util.findMaxMatchFile;var maxMatchLink=findMaxMatchFile(changeFilePath,linkStyles)[0];var maxMatchImport=findMaxMatchFile(changeFilePath,importStyles)[0];if(maxMatchLink&&maxMatchLink.isFullMatch){reloader.dom.reloadLinkStyle(maxMatchLink.file);hasMatch=true}if(maxMatchImport&&maxMatchImport.isFullMatch){reloader.dom.reloadImportStyle(maxMatchImport.file);hasMatch=true}if(!hasMatch){reloader.command.reloadPage()}},reloadImage:function(data){if(!document.querySelectorAll&&typeof jQuery==="undefined"){reloader.command.reloadPage()}var changeFilePath=reloader.getReloadFile(data.path);var hasReload=false;var reloadVersion=(new Date).getTime();hasReload=reloadImageElement(changeFilePath,reloadVersion);var result=reloadInlineStyleImage(changeFilePath,reloadVersion);hasReload||(hasReload=result);result=reloadStyleSheetImage(changeFilePath,reloadVersion);hasReload||(hasReload=result);if(!hasReload){reloader.command.reloadPage()}},reloadPage:function(){window.document.location.reload()}};function log(type,msg){var typeMap={info:"log",warn:"warn",error:"error"};var logLevel={info:1,warn:2,error:3};var options=reloader.options;if(logLevel[type]<(logLevel[options.logLevel]||logLevel.info)){return}var console=window.console;if(console){var logInfo=console[typeMap[type]]||console.log;if(typeof logInfo==="function"){logInfo.call(console,"[watchreload-"+type+"]: "+msg)}}}reloader.log={info:function(message){log("info",message)},warn:function(message){log("warn",message)},error:function(message){log("error",message)}};reloader.socket={initMessageListener:function(){var socket=this._socket;socket.on("command",function(data){reloader.log.info("receive command: "+io.JSON.stringify(data));var handler=reloader.command[data.type];delete data.type;handler&&handler(data)});socket.on("connect",function(){socket.emit("register",{name:navigator.userAgent});reloader.log.info("connection is successful.")});socket.on("disconnect",function(){reloader.log.info("connection is disconnected.")});socket.on("reconnecting",function(){reloader.log.info("reconnection...")})},sendMessage:function(msgType,data){var socket=this._socket;if(socket){socket.emit(msgType,data||{})}},open:function(){this._socket=io.connect("http://{{ip}}:{{port}}");this.initMessageListener()},close:function(){var socket=this._socket;socket.removeAllListeners();socket.disconnect();this._socket=null}};reloader.socket.open()})(window,document,window.io,window._browserReloader||(window._browserReloader={}));